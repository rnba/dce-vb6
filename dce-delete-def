#!/usr/bin/execlineb -WP

multisubstitute {
  importas -i file file
  importas -i t t
  importas -i n n
}

define import "^[[:space:]]*(P(ublic|rivate)[[:space:]]+)?Declare[[:space:]]+${t}[[:space:]]+${n}($|[^_[:alnum:]])"
define const  "^[[:space:]]*(P(ublic|rivate)[[:space:]]+)Const[[:space:]]+${n}($|[^_[:alnum:]])"
define proto  "^[[:space:]]*(P(ublic|rivate)[[:space:]]+)?${t}[[:space:]]+([GS]et[[:space:]]+)?${n}($|[^_[:alnum:]])"

exec sed -Eni "
  /^'.*/ {
    h; n
    :comment
    /^'.*/ {
      H; n; b comment
    }
    /${import}/I {
      b import
    }
    /${const}/I {
      b const
    }
    /${proto}/I {
      b def
    }
    # the comment did not precede our function
    # print the comment saved up in the hold space
    # followed by the current line, then start
    # a new cycle
    x; p
    x; p
    b
  }

  :import
  /${import}/I {
    :ibody
    /_$/ {
      n; b ibody
    }
    n; b tail
  }

  :const
  /${const}/I {
    :cbody
    /_$/ {
      n; b cbody
    }
    n; b tail
  }

  :def
  /${proto}/I {
    :dbody
    /end[[:space:]]+${t}/I {
      n; b tail
    }
    n; b dbody
  }

  :unrelated
  p; b

  :tail
  /^[[:space:]]*$/ {
    n; b tail;
  }
  b unrelated
  " $file
